# Working with patches

Patch files are used to apply the changes to repositories imported with Bazel's
[`http_archive`](https://docs.bazel.build/versions/main/repo/http.html) rule.

## Generating the patch files

The patch files are generated with `git diff` command which displays the diff
between the workspace and the last committed version.

Typical workflow for generating the patch files is described on example of
`llvm` repository below. The repository is imported into reclient WORKSPACE from
https://github.com/llvm/llvm-project/ and
[`settings.bzl`](https://github.com/bazelbuild/reclient/tree/main/settings.bzl)
file defines the commit that should be downloaded.

To generate the patch file, the user should:

1.  Clone the remote repository by running `git clone
    https://github.com/llvm/llvm-project/`
1.  Checkout the same commit that's imported by reclient (e.g. `git checkout
    39e2e3bddbf459d16b00969af1415ebee11fcbdc`)
1.  Make the necessary changes in `llvm-project` repository
1.  Generate the patch file by running `git diff >
    <re-client-workspace>/third_party/patches/<patch-name>.patch`

## Applying patches

Patches are applied after `http_archive` extracts the archive. To add the patch
that you'd like to apply, add it to patches argument of the `http_archive` rule.
Example:

```
...
patch_args = ["-p1"],
patches = [
        "//third_party/patches/llvm:llvm-status-is-for-dir.patch",
...
],
...
```

**Notes:**

1.  `patch_args = ["-p1"]` is required when applying patch files generated by
    `git diff` command. (see
    [`http_archive` documentation](https://docs.bazel.build/versions/main/repo/http.html)
    for more details).
1.  Patches are applied in the same order as they're declared in the `patches`
    argument (`patches = ["//1.patch", "//2.patch"]` may produce different
    results than `patches = ["//2.patch", "//1.patch"]`).

## Updating the patched repository

Sometimes, especially after updating the version imported by `http_archive`
rule, applying existing patches may fail. In such cases it's useful to try to
apply the patch in your local repository and manually fix the changes that were
rejected by following steps below (`llvm` repo used as an example):

1.  Clone the remote repository by running `git clone
    https://github.com/llvm/llvm-project/`
1.  Checkout the same commit that's imported by reclient (e.g. `git checkout
    39e2e3bddbf459d16b00969af1415ebee11fcbdc`)
1.  Try to apply the patch with `git apply --reject --whitespace=fix
    <re-client-workspace>/third_party/patches/<patch-name>.patch`. If the
    command failed to apply some of the changes, `<patch-name>.patch.rej` file
    will be generated.
1.  Review the content of `<patch-name>.patch.rej` file and apply the changes
    manually
1.  Remove `<patch-name>.patch.rej`
1.  Generate updated patch file by running `git diff >
    <re-client-workspace>/third_party/patches/<patch-name>.patch`

**Note:** Please note that the order of patches matters and they should be
applied in the same order that they were declared in the `patches` parameter of
`http_archive` rule.
